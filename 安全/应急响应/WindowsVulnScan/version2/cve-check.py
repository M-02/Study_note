import requests
import sqlite3
import json
import hashlib
import math
import datetime
import re
import threading
import time
import argparse
from pathlib import Path
# 删除一些ssl 认证的warnging信息
requests.packages.urllib3.disable_warnings()

ThreadCount=20
DATA_PER_PAGE = 500
DBFileName="2021-CVEKB.db"
TableName="CVEKB"
insertSQL = []
updateSQL = []
lock = threading.Lock()
KBResult = {}
parser = argparse.ArgumentParser()
parser.add_argument("-u","--update-cve",help="更新CVEKB数据",action="store_true")
parser.add_argument("-U","--update-exp",help="更新CVEEXP数据",action="store_true")
parser.add_argument("-m","--mode",help="搭配-U使用。更新模式 All:更新所有;Empty:只更新空白的;Error:只更新之前未成功更新的")
parser.add_argument("-C","--check-EXP",help="检索具有EXP的CVE",action="store_true")
parser.add_argument("-n","--productName",help="搭配-C使用。自定义产品名称，如Windows 10")
parser.add_argument("-N","--productVersion",help="搭配-C使用。自定义产品版本，如20H2")
parser.add_argument("-f","--file",help="ps1脚本运行后产生的.json文件")
args = parser.parse_args()

class CVEScanThread(threading.Thread):
    def __init__(self,func,args,name="",):
        threading.Thread.__init__(self)
        self.func = func
        self.args = args
        self.name = name 
        self.result = None

    def run(self):
        print("thread:{} :start scan page {}".format(self.args[1],self.args[0]))
        self.result = self.func(self.args[0],)
        print("thread:{} :stop scan page {}".format(self.args[1],self.args[0]))

class EXPScanThread(threading.Thread):
    def __init__(self,func,args,name="",):
        threading.Thread.__init__(self)
        self.func = func
        self.args = args
        self.name = name 
        self.result = None

    def run(self):
        print("thread:{} :start scan CVE: {},xuhao:{}".format(self.args[1],self.args[0],self.args[2]))
        self.result = self.func(self.args[0],)
        print("thread:{} :stop scan CVE: {}".format(self.args[1],self.args[0]))
    def get_result(self):
        threading.Thread.join(self)
        try:
            return self.result
        except Exception:
            return "Error"


# 获取一共有多少页
def get_page_num(dstDateStrArg = None):
    headers = {
        'origin': "https://msrc.microsoft.com",
        'referer': "https://msrc.microsoft.com/update-guide",
        'accept-language': "zh-CN",
        'user-agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/16.16299",
        'accept': "application/json, text/plain, */*",
        'accept-encoding': "gzip, deflate",
        'host': "api.msrc.microsoft.com",
        'connection': "close",
        'cache-control': "no-cache",
        }

    url = "https://api.msrc.microsoft.com/sug/v2.0/en-US/affectedProduct"
    dstDateStr = str(datetime.date.today()) if dstDateStrArg == None else dstDateStrArg
    params = {
        "$$orderby":"releaseDate desc",
        "$filter":"(releaseDate gt 1000-03-01T00:00:00+08:06) and (releaseDate lt "+ dstDateStr +"T23:59:59+08:00)",
    }
    dataCount = 500
    try:
        response = requests.request("GET", url, params=params, headers=headers, verify = False)
        dataCount = json.loads(response.text)['@odata.count']
    except Exception as e:
        print(e)
    return math.ceil(int(dataCount)/DATA_PER_PAGE)

# 更新CVEKB数据库
def update_cvekb_database(num=1,pageSize=100):
    # Step1. 总共有多少页
    pageCount = get_page_num()
    i = 1
    tmpCount = ThreadCount
    while i <= pageCount:
        tmpCount = ThreadCount if (pageCount - i) >= ThreadCount else pageCount - i
        print("i:{},pageCount-i:{},ThreadCount:{},PageCount:{}".format(i,pageCount-i,ThreadCount,pageCount))
        time.sleep(0.5)    
        threads = []
        print("===============================")
        # 对于每一个线程
        for j in range(1,tmpCount + 1):
            print("更新第{}页".format(i+j-1))
            t = CVEScanThread(update_onepage_cvedb_database,(i+j-1,j,),str(j))
            threads.append(t)
        for t in threads:
            t.start()
        for t in threads:
            t.join()
            # update_onepage_cvedb_database(num=i)
        i = i + tmpCount
        conn = sqlite3.connect(DBFileName)
        for sql in insertSQL:
            conn.execute(sql)
        conn.commit()
        conn.close()
        if tmpCount != ThreadCount:
            break
        
# 检查每一个CVE是否有poc        
def check_POC_every_CVE(CVEName=""):
    #apiKey = ""
    #url = "https://exploits.shodan.io/api/search?query=" + CVEName + "&key=" + apiKey
    url = "https://exploits.shodan.io/?q=" + CVEName
    try:
        response = requests.request("GET",url=url,verify=False,timeout=30)
        #total = json.loads(response.text)
    except Exception as e:
        print("Error,{}".format(CVEName))
        print(e)
        return "Error"
    if "Total Results" not in response.text:
        return "False"
    else:
        return "True"

# 更新CVEKB数据库(按页)
def update_onepage_cvedb_database(num=1,pageSize=500):
    pass
    skip = num * DATA_PER_PAGE
    headers = {
        'origin': "https://msrc.microsoft.com",
        'referer': "https://msrc.microsoft.com/update-guide",
        'accept-language': "zh-CN",
        'user-agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/16.16299",
        'accept': "application/json, text/plain, */*",
        'accept-encoding': "gzip, deflate",
        'host': "api.msrc.microsoft.com",
        'connection': "close",
        'cache-control': "no-cache",
        }

    url = "https://api.msrc.microsoft.com/sug/v2.0/en-US/affectedProduct"
    params = {
        "$$orderby":"releaseDate desc",
        "$filter":"(releaseDate gt 1000-03-01T00:00:00+08:06) and (releaseDate lt "+str(datetime.date.today())+"T23:59:59+08:00)",
        "$skip":skip
    }
   # print(params)
    resultList = []
    try:
        response = requests.request("GET", url, params=params, headers=headers, verify = False)
        resultList = json.loads(response.text)['value']
    except Exception as e:
        print(e)
        #print(response.text)
    conn = sqlite3.connect(DBFileName)
    create_sql = """Create Table IF NOT EXISTS {} (
        hash TEXT UNIQUE,
        name TEXT,
        KBName TEXT,
        CVEName TEXT,
        impact TEXT,
        hasPOC TEXT)""".format(TableName)
    conn.execute(create_sql)
    conn.commit()
    conn.close()
    for result in resultList:
        KBName = ""
        for KBNode in result['kbArticles']:
            KBName += KBNode['articleName'] + ";" if (KBNode['articleName'] != None) and KBNode['articleName'].isdigit() else ""
        if KBName == "":
            continue
        h1 = hashlib.md5()
        metaStr = result['product'] + KBName + result['cveNumber'] + result['impact']
        h1.update(metaStr.encode('utf-8'))
        #hasPOC = check_POC_every_CVE(result['cveNumber'])
        # 收集到所有的KB后再搜索有没有公开的EXP
        hasPOC = ""
        sql = "INSERT OR IGNORE INTO "+TableName+" VALUES ('" + h1.hexdigest() + "','" + result['product'] + "','" + KBName + "','" + result['cveNumber'] + "','" + result['impact'] + "','" + hasPOC+"')"
        with lock:
            global insertSQL
            insertSQL.append(sql)


# 根据系统版本查找CVE
def select_CVE(tmpList=[],windowsProductName="",windowsVersion=""):
    conn = sqlite3.connect(DBFileName)
    con = conn.cursor()
    intersectionList = []
    count = 0
    for i in tmpList:
        sql = 'select distinct(CVEName) from '+ TableName+' where (name like "'+ windowsProductName+'%'+ windowsVersion + '%") and ("'+ i +'" not in (select KBName from '+ TableName +' where name like "'+ windowsProductName+'%'+windowsVersion+'%")); '
        cveList = []
        for cve in con.execute(sql):
            cveList.append(cve[0])
        if count == 0:
            intersectionList = cveList.copy()
        count +=1
        intersectionList = list(set(intersectionList).intersection(set(cveList)))
    intersectionList.sort()
    for cve in intersectionList:
        # 查看cve是哪方面的
        sql_query_impact = "select impact from {} where CVEName == '{}' and hasPOC == 'True'".format(TableName,cve)
        for impact in con.execute(sql_query_impact):
            if len(con.fetchall()) != 0:
                print("[+]{} \t".format(impact[0]),end="")

        # 查找是否有公开的exp
        sql = "select CVEName from {} where CVEName == '{}' and hasPOC == 'True'".format(TableName,cve)
        # print(sql)
        con.execute(sql)
        if len(con.fetchall()) != 0:
            print("{} has EXP".format(cve))
    # print(intersectionList)


# 更新CVEKB数据库中的hasPOC字段
def update_hasPOC(key = "Empty"):
    conn = sqlite3.connect(DBFileName)
    con = conn.cursor()
    if key == "All":
        sql = "select distinct(CVEName) from {}".format(TableName)
    elif key == "Empty":
        sql = "select distinct(CVEName) from {} where (hasPOC IS NULL) OR (hasPOC == '')".format(TableName)
    elif key == "Error":
        sql = "select distinct(CVEName) from {} where (hasPOC == 'Error')".format(TableName)
    con.execute(sql)
    cveNameList = con.fetchall()
    i = 0
    count = 1
    while i < len(cveNameList):
        print("|=========={}============|".format(i))
        # tmpCount = ThreadCount if (len(cveNameList) - i) >= ThreadCount else len(cveNameList) - i
        # threads = []
        # for j in range(1,tmpCount+1):
        #     t = EXPScanThread(check_POC_every_CVE,(cveNameList[i+j][0],j,i+j,),str(j))
        #     threads.append(t)
        # for t in threads:
        #     t.start()
        # for t in threads:
        #     t.join()
        # j = 1
        # for t in threads:
        #     hasPOC = t.get_result()
        #     print(hasPOC)
        #     update_sql = "UPDATE "+TableName+" set hasPOC = '" + hasPOC + "' WHERE cveName == '" + cveNameList[i+j][0] +"';"
        #     conn.execute(update_sql)
        #     print("[+] update:{}".format(update_sql))
        #     j += 1
        # i=i+ThreadCount
        # conn.commit()
        hasPOC = check_POC_every_CVE(cveNameList[i][0])
        time.sleep(0.3)
        update_sql = "UPDATE "+TableName+" set hasPOC = '" + hasPOC + "' WHERE cveName == '" + cveNameList[i][0] +"';"
        conn.execute(update_sql)
        print(update_sql)
        if count == 10:
            conn.commit()
            print("[+]update")
            count = 1
        else:
            count += 1
        i += 1


    conn.commit()
    conn.close()
    print("Over")


if __name__ == "__main__":
    banner = """
    ========CVE-EXP-Check===============
    |       author:JC0o0l               |
    |       wechat:JC_SecNotes          |
    |       version:2.0                 |
    =====================================
    """
    print(banner)
    if (not args.check_EXP ) and (not args.update_cve) and (not args.update_exp) and args.file is None:
        parser.print_help()
    if args.update_cve:
        update_cvekb_database()
    if args.update_exp:
        dbfile=Path(DBFileName)
        key = ""
        if args.mode:
            key = args.mode
        else:
            key = "All"
        if dbfile.exists():
            update_hasPOC(key=key)
        else:
            print("请先使用-u 创建数据库")
            parser.print_help()
    if args.check_EXP:
        dbfile=Path(DBFileName)
        if not dbfile.exists():
            print("请先使用-u 创建数据库，之后使用 -U 更新是否有EXP")
            parser.print_help()
            exit()
        if args.file:
            #with open(args.file,"r",encoding="utf-8") as f:
                #KBResult = json.load(f)
            with open(args.file,"r",encoding="utf-8-sig",errors="ignore") as f:
                KBResult = json.load(f,strict=False)
            windowsProductName = KBResult['basicInfo']['windowsProductName']
            windowsProductName = ((re.search("\w[\w|\s]+\d+[\s|$]",windowsProductName).group()).strip()).replace("Microsoft","").strip()
            windowsVersion = KBResult['basicInfo']['windowsVersion']
            # win10 20H2版本
            if windowsVersion == "2009":
                windowsVersion = "20H2"
            if args.productName:
                windowsProductName = args.productName
            if args.productVersion:
                windowsVersion = args.productVersion
            print("系统信息如下:")
            print("{} {}".format(windowsProductName,windowsVersion))
            tmpKBList = KBResult['KBList']
            KBList = []
            for KB in tmpKBList:
                KBList.append(KB.replace("KB",""))
            print("KB信息如下:")
            print(KBList)
            print("EXP信息如下:")
            select_CVE(tmpList=KBList,windowsProductName=windowsProductName,windowsVersion=windowsVersion)
        else:
            print("请输入.json文件")    
    
